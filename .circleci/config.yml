version: 2
jobs:
  build:
    docker:
      - image: alpine:3.4
    environment:
      HEROKU_APP_NAME: young-peak-91678
      HEROKU_REGISTRY_IMAGE: registry.heroku.com/${HEROKU_APP_NAME}/web
    steps:
      - checkout
      # start proprietary DB using private Docker image
      - run:
          name: setup environment
          command: |
              apk add --no-cache curl
              chmod +x ./release.sh
      - run:
          name: build docker image
          command: docker build --tag $HEROKU_REGISTRY_IMAGE --file ./Dockerfile.prod .
      - run:
          name: heloku login
          command:
              docker login -u _ -p $HEROKU_API_KEY registry.heroku.com
      - run:
          name: push docker image and release
          command: |
              docker push $HEROKU_REGISTRY_IMAGE
              ./release.sh

  test:
    docker:
      - image: alpine:3.4
    steps:
      - run:
          name: Run test and formatter
          environment:
              POSTGRES_DB: users
              POSTGRES_USER: runner
              POSTGRES_PASSWORD: ""
              DATABASE_TEST_URL: postgres://runner@postgres:5432/users
          command: |
              pytest "project/tests" -p no:warnings
              flake8 project
              black project --check
              isort project/**/*.py --check-only
      - setup_remote_docker
  deploy:
    docker:
      - image: alpine:3.4
    environment:
      HEROKU_APP_NAME: young-peak-91678
      HEROKU_REGISTRY_IMAGE: registry.heroku.com/${HEROKU_APP_NAME}/web
    steps:
      - checkout
      # start proprietary DB using private Docker image
      - run:
          name: setup environment
          command: |
              apk add --no-cache curl
              chmod +x ./release.sh
      - run:
          name: build docker image
          command: docker build --tag $HEROKU_REGISTRY_IMAGE --file ./Dockerfile.prod .
      - run:
          name: heloku login
          command:
              docker login -u _ -p $HEROKU_API_KEY registry.heroku.com
      - run:
          name: push docker image and release
          command: |
              docker push $HEROKU_REGISTRY_IMAGE
              ./release.sh
workflow:
  version: 2
  build_and_test_and_deploy:
    jobs:
      - build
      - test
      - deploy